FROM debian:stable-slim AS builder

ARG VERSION
ARG TARGETARCH

RUN apt-get update && apt-get install -y curl unzip ca-certificates && \
    rm -rf /var/lib/apt/lists/*

RUN if [ "$TARGETARCH" = "amd64" ]; then ARCH="amd64"; else ARCH="arm64"; fi && \
    echo "=== Build Information ===" && \
    echo "TARGETARCH: $TARGETARCH" && \
    echo "ARCH: ${ARCH}" && \
    echo "VERSION: ${VERSION}" && \
    echo "VERSION length: ${#VERSION}" && \
    if [ -z "$VERSION" ]; then echo "ERROR: VERSION is empty!"; exit 1; fi && \
    URL="https://github.com/anytls/anytls-go/releases/download/v${VERSION}/anytls_${VERSION}_linux_${ARCH}.zip" && \
    echo "Full URL: ${URL}" && \
    echo "=======================" && \
    curl -fSL -o /tmp/anytls.zip "${URL}" && \
    unzip /tmp/anytls.zip -d /tmp && \
    chmod +x /tmp/anytls-client && \
    rm /tmp/anytls.zip

FROM debian:stable-slim

RUN apt-get update && apt-get install -y ca-certificates && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -r -s /sbin/nologin anytls

COPY --from=builder /tmp/anytls-client /usr/local/bin/
COPY entrypoint-client.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh

USER anytls

ENV LISTEN_ADDR=127.0.0.1:1080
ENV SERVER_URI=""
ENV SERVER_ADDR=""
ENV PASSWORD=""

ENTRYPOINT ["/entrypoint.sh"]
