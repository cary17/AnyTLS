  verify:
    needs: [check-version, build-versions, create-pure-latest-tags]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub credentials
        id: verify-check-dockerhub
        run: |
          if [ -n "${{ env.DOCKERHUB_USERNAME }}" ] && [ -n "${{ env.DOCKERHUB_TOKEN }}" ]; then
            echo "dockerhub_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "dockerhub_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.verify-check-dockerhub.outputs.dockerhub_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Verify images
        run: |
          /bin/bash << 'EOF'
          VERSION="${{ needs.check-version.outputs.version }}"
          GHCR_BASE="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          
          echo "=== AnyTLS 镜像验证 ==="
          echo ""
          
          # 检查 GHCR 镜像
          echo "1. 验证 GHCR 镜像:"
          
          TAGS=(
            "纯latest标签 (无后缀): ${GHCR_BASE}:latest"
            "版本号标签 (无后缀): ${GHCR_BASE}:${VERSION}"
            "版本号server变体: ${GHCR_BASE}:${VERSION}-server"
            "版本号client变体: ${GHCR_BASE}:${VERSION}-client"
            "latest-server标签: ${GHCR_BASE}:latest-server"
            "latest-client标签: ${GHCR_BASE}:latest-client"
          )
          
          for TAG_INFO in "${TAGS[@]}"; do
            DESCRIPTION="${TAG_INFO%:*}"
            TAG="${TAG_INFO#*: }"
            echo -n "   ${DESCRIPTION}: "
            docker buildx imagetools inspect "$TAG" >/dev/null 2>&1 && echo "✓ 存在" || echo "✗ 不存在"
          done
          
          echo ""
          
          # 检查 Docker Hub 镜像
          if [ "${{ steps.verify-check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
            DOCKER_BASE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
            
            echo "2. 验证 Docker Hub 镜像:"
            
            DOCKER_TAGS=(
              "纯latest标签 (无后缀): ${DOCKER_BASE}:latest"
              "版本号标签 (无后缀): ${DOCKER_BASE}:${VERSION}"
              "版本号server变体: ${DOCKER_BASE}:${VERSION}-server"
              "版本号client变体: ${DOCKER_BASE}:${VERSION}-client"
              "latest-server标签: ${DOCKER_BASE}:latest-server"
              "latest-client标签: ${DOCKER_BASE}:latest-client"
            )
            
            for TAG_INFO in "${DOCKER_TAGS[@]}"; do
              DESCRIPTION="${TAG_INFO%:*}"
              TAG="${TAG_INFO#*: }"
              echo -n "   ${DESCRIPTION}: "
              docker buildx imagetools inspect "$TAG" >/dev/null 2>&1 && echo "✓ 存在" || echo "✗ 不存在"
            done
            
            echo ""
          else
            echo "2. Docker Hub 未配置，跳过验证"
            echo ""
          fi
          
          # 测试拉取关键镜像
          echo "3. 测试拉取关键镜像:"
          KEY_TAGS=(
            "${GHCR_BASE}:latest"
            "${GHCR_BASE}:${VERSION}"
            "${GHCR_BASE}:latest-server"
            "${GHCR_BASE}:latest-client"
          )
          
          for TAG in "${KEY_TAGS[@]}"; do
            echo -n "   拉取 ${TAG}... "
            docker pull "$TAG" --quiet 2>/dev/null && echo "✓ 成功" || echo "✗ 失败"
          done
          
          echo ""
          
          # 显示镜像信息
          echo "4. 镜像信息:"
          echo "   架构支持: linux/amd64, linux/arm64"
          echo ""
          
          # 使用示例
          echo "5. 使用示例:"
          echo "   GHCR 纯latest标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest"
          echo ""
          echo "   GHCR latest-server标签:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest-server"
          echo ""
          echo "   GHCR latest-client标签:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:latest-client"
          echo ""
          echo "   GHCR 版本号标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}"
          echo ""
          echo "   GHCR 版本号server变体:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}-server"
          echo ""
          echo "   GHCR 版本号client变体:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:${VERSION}-client"
          
          if [ "${{ steps.verify-check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
            DOCKER_BASE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
            echo ""
            echo "   Docker Hub 纯latest标签 (server, 无后缀):"
            echo "   docker run -d --name anytls-server ${DOCKER_BASE}:latest"
          fi
          
          echo ""
          echo "=== 验证完成 ==="
          echo "所有镜像均已成功构建和推送"
          EOF
