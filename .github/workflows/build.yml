name: Build Docker Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'AnyTLS version (e.g. v0.0.12, leave empty for latest)'
        required: false
        type: string
      force_build:
        description: 'Force build'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKER: docker.io
  IMAGE_NAME: anytls-go

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      version_no_v: ${{ steps.check.outputs.version_no_v }}
    steps:
      - name: Check version availability
        id: check
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
        run: |
          set -x
          FORCE_BUILD="${{ github.event.inputs.force_build }}"
          MANUAL_VERSION="${{ github.event.inputs.version }}"
          
          # 通用函数：获取 GHCR token
          get_ghcr_token() {
            curl -fsSL "https://ghcr.io/token?scope=repository:${{ github.repository_owner }}/anytls-go:pull" | jq -r '.token // empty'
          }
          
          # 通用函数：检查标签是否存在
          check_tag_exists() {
            local token=$1
            local tag=$2
            
            if [ -z "$token" ]; then
              return 1
            fi
            
            # 检查标签是否存在
            RESPONSE=$(curl -fsSL -H "Authorization: Bearer $token" \
              "https://ghcr.io/v2/${{ github.repository_owner }}/anytls-go/manifests/${tag}" 2>/dev/null || echo "")
            
            if [ -n "$RESPONSE" ]; then
              return 0  # 存在
            else
              return 1  # 不存在
            fi
          }
          
          # 如果强制构建，则直接使用指定版本或最新版本
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "Force build enabled"
            if [ -n "$MANUAL_VERSION" ]; then
              VERSION="$MANUAL_VERSION"
            else
              VERSION=$(curl -s -H "Authorization: token $GH_TOKEN" \
                https://api.github.com/repos/anytls/anytls-go/releases/latest | \
                jq -r .tag_name)
            fi
            echo "Version: $VERSION"
            VERSION_NO_V="${VERSION#v}"
            echo "Version without v: $VERSION_NO_V"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 获取 GHCR token
          GHCR_TOKEN=$(get_ghcr_token)
          if [ -z "$GHCR_TOKEN" ]; then
            echo "警告：无法获取 GHCR token，将假定需要构建"
          fi
          
          # 如果有手动指定的版本
          if [ -n "$MANUAL_VERSION" ]; then
            echo "Manual version specified: $MANUAL_VERSION"
            
            # 确保版本号格式正确
            MANUAL_VERSION=$(echo "$MANUAL_VERSION" | tr -d '\n\r\t ')
            if [[ ! "$MANUAL_VERSION" =~ ^v ]]; then
              MANUAL_VERSION="v$MANUAL_VERSION"
            fi
            
            # 检查是否已存在该版本（主标签）
            if [ -n "$GHCR_TOKEN" ]; then
              echo "检查 GHCR 是否已存在版本: $MANUAL_VERSION"
              
              # 检查主标签
              if check_tag_exists "$GHCR_TOKEN" "$MANUAL_VERSION"; then
                echo "版本 $MANUAL_VERSION 已存在于 GHCR，跳过构建"
                echo "should_build=false" >> $GITHUB_OUTPUT
                echo "version=$MANUAL_VERSION" >> $GITHUB_OUTPUT
                echo "version_no_v=${MANUAL_VERSION#v}" >> $GITHUB_OUTPUT
                exit 0
              fi
              
              # 检查server变体标签
              if check_tag_exists "$GHCR_TOKEN" "${MANUAL_VERSION}-server"; then
                echo "版本 $MANUAL_VERSION-server 已存在于 GHCR，跳过构建"
                echo "should_build=false" >> $GITHUB_OUTPUT
                echo "version=$MANUAL_VERSION" >> $GITHUB_OUTPUT
                echo "version_no_v=${MANUAL_VERSION#v}" >> $GITHUB_OUTPUT
                exit 0
              fi
              
              echo "版本 $MANUAL_VERSION 不存在于 GHCR，需要构建"
            else
              echo "无法检查 GHCR，假定需要构建"
            fi
            
            VERSION_NO_V="${MANUAL_VERSION#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$MANUAL_VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 自动检测版本逻辑：比较上游最新版本和GHCR已有版本
          echo "开始自动版本检测..."
          
          # 获取上游最新版本
          UPSTREAM_LATEST=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/anytls/anytls-go/releases/latest | \
            jq -r .tag_name || echo "")
          
          if [ -z "$UPSTREAM_LATEST" ]; then
            echo "无法获取上游最新版本"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest upstream version: $UPSTREAM_LATEST"
          
          # 获取GHCR中已存在的版本号
          if [ -n "$GHCR_TOKEN" ]; then
            # 获取所有标签并筛选出版本号标签
            RESPONSE=$(curl -fsSL -H "Authorization: Bearer $GHCR_TOKEN" \
              "https://ghcr.io/v2/${{ github.repository_owner }}/anytls-go/tags/list" || echo '{"tags":[]}')
            
            # 从标签列表中提取纯版本号标签（格式：vX.Y.Z）
            GHCR_VERSION=$(echo "$RESPONSE" | jq -r '.tags[]?' | \
              grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1 || echo "v0.0.0")
            
            echo "Current GHCR version: $GHCR_VERSION"
            
            # 比较版本号
            if [ "$(printf '%s\n' "$UPSTREAM_LATEST" "$GHCR_VERSION" | sort -V | tail -1)" = "$UPSTREAM_LATEST" ] && \
               [ "$UPSTREAM_LATEST" != "$GHCR_VERSION" ]; then
              echo "New version available, building..."
              VERSION_NO_V="${UPSTREAM_LATEST#v}"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "version=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
              echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            else
              echo "Already up to date"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            # 无法获取GHCR token，保守起见构建最新版本
            echo "无法检查GHCR状态，构建最新版本: $UPSTREAM_LATEST"
            VERSION_NO_V="${UPSTREAM_LATEST#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
          fi

  build-versions:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        variant: [server, client]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub credentials
        id: check-dockerhub
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "dockerhub_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "dockerhub_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.check-dockerhub.outputs.dockerhub_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate version tags
        id: meta
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          VARIANT="${{ matrix.variant }}"
          
          # 生成版本号标签和带变体的latest标签
          if [ "$VARIANT" = "server" ]; then
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}-server,${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-server"
            
            # 只在 Docker Hub 启用时添加 Docker Hub 标签
            if [ "${{ steps.check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
              DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-server,${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-server"
            else
              DOCKER_TAGS=""
            fi
          else
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-client"
            
            # 只在 Docker Hub 启用时添加 Docker Hub 标签
            if [ "${{ steps.check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
              DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-client"
            else
              DOCKER_TAGS=""
            fi
          fi
          
          # 构建完整的 tags 字符串
          if [ -n "$DOCKER_TAGS" ]; then
            echo "tags=${GHCR_TAGS},${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          else
            echo "tags=${GHCR_TAGS}" >> $GITHUB_OUTPUT
          fi

      - name: Debug version info
        run: |
          echo "Version: ${{ needs.check-version.outputs.version }}"
          echo "Version without v: ${{ needs.check-version.outputs.version_no_v }}"

      - name: Build and push version tags
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VERSION=${{ needs.check-version.outputs.version_no_v }}
          cache-from: type=gha,scope=anytls-${{ matrix.variant }}-versions
          cache-to: type=gha,mode=max,scope=anytls-${{ matrix.variant }}-versions

  create-pure-latest-tags:
    needs: [check-version, build-versions]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub credentials
        id: check-dockerhub
        run: |
          if [ -n "${{ env.DOCKERHUB_USERNAME }}" ] && [ -n "${{ env.DOCKERHUB_TOKEN }}" ]; then
            echo "dockerhub_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "dockerhub_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.check-dockerhub.outputs.dockerhub_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Prepare pure latest tags
        id: prepare
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          
          echo "准备创建纯latest标签引用"
          echo "版本: $VERSION"
          
          # 定义源标签和目标标签
          GHCR_SOURCE="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-server"
          GHCR_TARGET="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          
          # 存储变量供后续步骤使用
          echo "ghcr_source=${GHCR_SOURCE}" >> $GITHUB_OUTPUT
          echo "ghcr_target=${GHCR_TARGET}" >> $GITHUB_OUTPUT
          
          # 检查是否启用了 Docker Hub
          if [ "${{ steps.check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
            DOCKER_SOURCE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-server"
            DOCKER_TARGET="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
            echo "docker_source=${DOCKER_SOURCE}" >> $GITHUB_OUTPUT
            echo "docker_target=${DOCKER_TARGET}" >> $GITHUB_OUTPUT
            echo "Docker Hub 已启用"
          else
            echo "Docker Hub 未启用"
          fi

      - name: Create GHCR pure latest tag
        run: |
          SOURCE="${{ steps.prepare.outputs.ghcr_source }}"
          TARGET="${{ steps.prepare.outputs.ghcr_target }}"
          
          echo "创建 GHCR 纯latest标签"
          echo "源: $SOURCE"
          echo "目标: $TARGET"
          
          # 检查源标签是否存在
          echo "检查源标签是否存在..."
          docker buildx imagetools inspect "$SOURCE" >/dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "源标签存在，创建纯latest标签引用..."
            docker buildx imagetools create -t "$TARGET" "$SOURCE"
            
            # 验证创建是否成功
            docker buildx imagetools inspect "$TARGET" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "✓ 成功创建 GHCR 纯latest标签: $TARGET"
            else
              echo "✗ 创建 GHCR 纯latest标签失败"
            fi
          else
            echo "✗ 源标签不存在: $SOURCE"
            echo "将使用版本号标签作为源..."
            
            # 尝试使用版本号标签作为源
            VERSION="${{ needs.check-version.outputs.version }}"
            VERSION_SOURCE="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}"
            
            echo "尝试使用版本号标签: $VERSION_SOURCE"
            docker buildx imagetools inspect "$VERSION_SOURCE" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              docker buildx imagetools create -t "$TARGET" "$VERSION_SOURCE"
              echo "✓ 使用版本号标签创建 GHCR 纯latest标签: $TARGET"
            else
              echo "✗ 版本号标签也不存在，无法创建纯latest标签"
            fi
          fi

      - name: Create Docker Hub pure latest tag
        if: steps.check-dockerhub.outputs.dockerhub_enabled == 'true'
        run: |
          SOURCE="${{ steps.prepare.outputs.docker_source }}"
          TARGET="${{ steps.prepare.outputs.docker_target }}"
          
          echo "创建 Docker Hub 纯latest标签"
          echo "源: $SOURCE"
          echo "目标: $TARGET"
          
          # 检查源标签是否存在
          echo "检查源标签是否存在..."
          docker buildx imagetools inspect "$SOURCE" >/dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "源标签存在，创建纯latest标签引用..."
            docker buildx imagetools create -t "$TARGET" "$SOURCE"
            
            # 验证创建是否成功
            docker buildx imagetools inspect "$TARGET" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "✓ 成功创建 Docker Hub 纯latest标签: $TARGET"
            else
              echo "✗ 创建 Docker Hub 纯latest标签失败"
            fi
          else
            echo "✗ 源标签不存在: $SOURCE"
            echo "将尝试其他源标签..."
            
            # 尝试使用版本号标签作为源
            VERSION="${{ needs.check-version.outputs.version }}"
            VERSION_SOURCE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}"
            
            echo "尝试使用版本号标签: $VERSION_SOURCE"
            docker buildx imagetools inspect "$VERSION_SOURCE" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              docker buildx imagetools create -t "$TARGET" "$VERSION_SOURCE"
              echo "✓ 使用版本号标签创建 Docker Hub 纯latest标签: $TARGET"
            else
              echo "✗ 版本号标签也不存在，尝试使用 GHCR 标签..."
              
              # 最后尝试使用 GHCR 的标签
              GHCR_SOURCE="${{ steps.prepare.outputs.ghcr_source }}"
              docker buildx imagetools inspect "$GHCR_SOURCE" >/dev/null 2>&1
              if [ $? -eq 0 ]; then
                docker buildx imagetools create -t "$TARGET" "$GHCR_SOURCE"
                echo "✓ 使用 GHCR 标签创建 Docker Hub 纯latest标签: $TARGET"
              else
                echo "✗ 所有源标签都不存在，无法创建 Docker Hub 纯latest标签"
              fi
            fi
          fi

  verify:
    needs: [check-version, build-versions, create-pure-latest-tags]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub credentials
        id: verify-check-dockerhub
        run: |
          if [ -n "${{ env.DOCKERHUB_USERNAME }}" ] && [ -n "${{ env.DOCKERHUB_TOKEN }}" ]; then
            echo "dockerhub_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "dockerhub_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.verify-check-dockerhub.outputs.dockerhub_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Verify images
        run: |
          /bin/bash << 'EOF'
          VERSION="${{ needs.check-version.outputs.version }}"
          GHCR_BASE="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          
          echo "=== AnyTLS 镜像验证 ==="
          echo ""
          
          # 检查 GHCR 镜像
          echo "1. 验证 GHCR 镜像:"
          
          TAGS=(
            "纯latest标签 (无后缀): ${GHCR_BASE}:latest"
            "版本号标签 (无后缀): ${GHCR_BASE}:${VERSION}"
            "版本号server变体: ${GHCR_BASE}:${VERSION}-server"
            "版本号client变体: ${GHCR_BASE}:${VERSION}-client"
            "latest-server标签: ${GHCR_BASE}:latest-server"
            "latest-client标签: ${GHCR_BASE}:latest-client"
          )
          
          for TAG_INFO in "${TAGS[@]}"; do
            DESCRIPTION="${TAG_INFO%:*}"
            TAG="${TAG_INFO#*: }"
            echo -n "   ${DESCRIPTION}: "
            docker buildx imagetools inspect "$TAG" >/dev/null 2>&1 && echo "✓ 存在" || echo "✗ 不存在"
          done
          
          echo ""
          
          # 检查 Docker Hub 镜像
          if [ "${{ steps.verify-check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
            DOCKER_BASE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
            
            echo "2. 验证 Docker Hub 镜像:"
            
            DOCKER_TAGS=(
              "纯latest标签 (无后缀): ${DOCKER_BASE}:latest"
              "版本号标签 (无后缀): ${DOCKER_BASE}:${VERSION}"
              "版本号server变体: ${DOCKER_BASE}:${VERSION}-server"
              "版本号client变体: ${DOCKER_BASE}:${VERSION}-client"
              "latest-server标签: ${DOCKER_BASE}:latest-server"
              "latest-client标签: ${DOCKER_BASE}:latest-client"
            )
            
            for TAG_INFO in "${DOCKER_TAGS[@]}"; do
              DESCRIPTION="${TAG_INFO%:*}"
              TAG="${TAG_INFO#*: }"
              echo -n "   ${DESCRIPTION}: "
              docker buildx imagetools inspect "$TAG" >/dev/null 2>&1 && echo "✓ 存在" || echo "✗ 不存在"
            done
            
            echo ""
          else
            echo "2. Docker Hub 未配置，跳过验证"
            echo ""
          fi
          
          # 测试拉取关键镜像
          echo "3. 测试拉取关键镜像:"
          KEY_TAGS=(
            "${GHCR_BASE}:latest"
            "${GHCR_BASE}:${VERSION}"
            "${GHCR_BASE}:latest-server"
            "${GHCR_BASE}:latest-client"
          )
          
          for TAG in "${KEY_TAGS[@]}"; do
            echo -n "   拉取 ${TAG}... "
            docker pull "$TAG" --quiet 2>/dev/null && echo "✓ 成功" || echo "✗ 失败"
          done
          
          echo ""
          
          # 显示镜像信息
          echo "4. 镜像信息:"
          echo "   架构支持: linux/amd64, linux/arm64"
          echo ""
          
          # 使用示例
          echo "5. 使用示例:"
          echo "   GHCR 纯latest标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest"
          echo ""
          echo "   GHCR latest-server标签:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest-server"
          echo ""
          echo "   GHCR latest-client标签:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:latest-client"
          echo ""
          echo "   GHCR 版本号标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}"
          echo ""
          echo "   GHCR 版本号server变体:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}-server"
          echo ""
          echo "   GHCR 版本号client变体:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:${VERSION}-client"
          
          if [ "${{ steps.verify-check-dockerhub.outputs.dockerhub_enabled }}" = "true" ]; then
            DOCKER_BASE="${{ env.REGISTRY_DOCKER }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
            echo ""
            echo "   Docker Hub 纯latest标签 (server, 无后缀):"
            echo "   docker run -d --name anytls-server ${DOCKER_BASE}:latest"
          fi
          
          echo ""
          echo "=== 验证完成 ==="
          echo "所有镜像均已成功构建和推送"
          EOF
