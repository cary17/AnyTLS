name: Build Docker Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'AnyTLS version (e.g. v0.0.12, leave empty for latest)'
        required: false
        type: string
      force_build:
        description: 'Force build'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKER: docker.io
  IMAGE_NAME: anytls-go

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      version_no_v: ${{ steps.check.outputs.version_no_v }}
    steps:
      - name: Check latest version
        id: check
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
        run: |
          set -x
          FORCE_BUILD="${{ github.event.inputs.force_build }}"
          MANUAL_VERSION="${{ github.event.inputs.version }}"
          
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "Force build enabled"
            if [ -n "$MANUAL_VERSION" ]; then
              VERSION="$MANUAL_VERSION"
            else
              VERSION=$(curl -s -H "Authorization: token $GH_TOKEN" \
                https://api.github.com/repos/anytls/anytls-go/releases/latest | \
                jq -r .tag_name)
            fi
            echo "Version: $VERSION"
            VERSION_NO_V="${VERSION#v}"
            echo "Version without v: $VERSION_NO_V"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -n "$MANUAL_VERSION" ]; then
            echo "Manual version specified: $MANUAL_VERSION"
            VERSION_NO_V="${MANUAL_VERSION#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$MANUAL_VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_VERSION=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/anytls/anytls-go/releases/latest | \
            jq -r .tag_name)
          echo "Latest upstream version: $LATEST_VERSION"
          
          GHCR_VERSION=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://ghcr.io/v2/${{ github.repository_owner }}/anytls-go/tags/list | \
            jq -r '.tags[]' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1 || echo "v0.0.0")
          echo "Current GHCR version: $GHCR_VERSION"
          
          if [ "$(printf '%s\n' "$LATEST_VERSION" "$GHCR_VERSION" | sort -V | tail -1)" = "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "$GHCR_VERSION" ]; then
            echo "New version available, building..."
            VERSION_NO_V="${LATEST_VERSION#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
          else
            echo "Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        variant: [server, client]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate tags
        id: meta
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          VARIANT="${{ matrix.variant }}"
          
          if [ "$VARIANT" = "server" ]; then
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
            DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION},${ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          else
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-client"
            DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-client"
          fi
          
          echo "tags=${GHCR_TAGS},${DOCKER_TAGS}" >> $GITHUB_OUTPUT

      - name: Debug version info
        run: |
          echo "Version: ${{ needs.check-version.outputs.version }}"
          echo "Version without v: ${{ needs.check-version.outputs.version_no_v }}"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VERSION=${{ needs.check-version.outputs.version_no_v }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
