name: Build Docker Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'AnyTLS version (e.g. v0.0.12, leave empty for latest)'
        required: false
        type: string
      force_build:
        description: 'Force build'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKER: docker.io
  IMAGE_NAME: anytls-go

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      version_no_v: ${{ steps.check.outputs.version_no_v }}
    steps:
      - name: Check latest version
        id: check
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
        run: |
          set -x
          FORCE_BUILD="${{ github.event.inputs.force_build }}"
          MANUAL_VERSION="${{ github.event.inputs.version }}"
          
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "Force build enabled"
            if [ -n "$MANUAL_VERSION" ]; then
              VERSION="$MANUAL_VERSION"
            else
              VERSION=$(curl -s -H "Authorization: token $GH_TOKEN" \
                https://api.github.com/repos/anytls/anytls-go/releases/latest | \
                jq -r .tag_name)
            fi
            echo "Version: $VERSION"
            VERSION_NO_V="${VERSION#v}"
            echo "Version without v: $VERSION_NO_V"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -n "$MANUAL_VERSION" ]; then
            echo "Manual version specified: $MANUAL_VERSION"
            VERSION_NO_V="${MANUAL_VERSION#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$MANUAL_VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_VERSION=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/anytls/anytls-go/releases/latest | \
            jq -r .tag_name)
          echo "Latest upstream version: $LATEST_VERSION"
          
          GHCR_VERSION=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://ghcr.io/v2/${{ github.repository_owner }}/anytls-go/tags/list | \
            jq -r '.tags[]' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1 || echo "v0.0.0")
          echo "Current GHCR version: $GHCR_VERSION"
          
          if [ "$(printf '%s\n' "$LATEST_VERSION" "$GHCR_VERSION" | sort -V | tail -1)" = "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "$GHCR_VERSION" ]; then
            echo "New version available, building..."
            VERSION_NO_V="${LATEST_VERSION#v}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT
          else
            echo "Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-versions:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        variant: [server, client]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate version tags
        id: meta
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          VARIANT="${{ matrix.variant }}"
          
          # 生成版本号标签和带变体的latest标签
          if [ "$VARIANT" = "server" ]; then
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}-server,${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-server"
            DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-server,${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-server"
          else
            GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest-client"
            DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${VERSION}-client,${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest-client"
          fi
          
          echo "tags=${GHCR_TAGS},${DOCKER_TAGS}" >> $GITHUB_OUTPUT

      - name: Debug version info
        run: |
          echo "Version: ${{ needs.check-version.outputs.version }}"
          echo "Version without v: ${{ needs.check-version.outputs.version_no_v }}"

      - name: Build and push version tags
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VERSION=${{ needs.check-version.outputs.version_no_v }}
          cache-from: type=gha,scope=anytls-${{ matrix.variant }}-versions
          cache-to: type=gha,mode=max,scope=anytls-${{ matrix.variant }}-versions

  build-pure-latest:
    needs: [check-version, build-versions]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate pure latest tags
        id: pure-latest-meta
        run: |
          # 只生成纯latest标签（无后缀）
          GHCR_TAGS="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          DOCKER_TAGS="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "tags=${GHCR_TAGS},${DOCKER_TAGS}" >> $GITHUB_OUTPUT

      - name: Build and push pure latest tag
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.server  # 使用server变体作为纯latest的基础
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.pure-latest-meta.outputs.tags }}
          build-args: |
            VERSION=${{ needs.check-version.outputs.version_no_v }}
          cache-from: type=gha,scope=anytls-pure-latest
          cache-to: type=gha,mode=max,scope=anytls-pure-latest

  verify:
    needs: [check-version, build-versions, build-pure-latest]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify images
        run: |
          /bin/bash << 'EOF'
          VERSION="${{ needs.check-version.outputs.version }}"
          GHCR_BASE="${{ env.REGISTRY_GHCR }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          DOCKER_BASE="${{ env.REGISTRY_DOCKER }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          
          echo "=== AnyTLS 镜像验证 ==="
          echo ""
          
          # 检查 GHCR 镜像
          echo "1. 验证 GHCR 镜像:"
          
          echo "   a) 纯latest标签 (无后缀): ${GHCR_BASE}:latest"
          docker manifest inspect "${GHCR_BASE}:latest" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   b) 版本号标签 (无后缀): ${GHCR_BASE}:${VERSION}"
          docker manifest inspect "${GHCR_BASE}:${VERSION}" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   c) 版本号server变体: ${GHCR_BASE}:${VERSION}-server"
          docker manifest inspect "${GHCR_BASE}:${VERSION}-server" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   d) 版本号client变体: ${GHCR_BASE}:${VERSION}-client"
          docker manifest inspect "${GHCR_BASE}:${VERSION}-client" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   e) latest-server标签: ${GHCR_BASE}:latest-server"
          docker manifest inspect "${GHCR_BASE}:latest-server" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   f) latest-client标签: ${GHCR_BASE}:latest-client"
          docker manifest inspect "${GHCR_BASE}:latest-client" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo ""
          
          # 检查 Docker Hub 镜像
          echo "2. 验证 Docker Hub 镜像:"
          
          echo "   a) 纯latest标签 (无后缀): ${DOCKER_BASE}:latest"
          docker manifest inspect "${DOCKER_BASE}:latest" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   b) 版本号标签 (无后缀): ${DOCKER_BASE}:${VERSION}"
          docker manifest inspect "${DOCKER_BASE}:${VERSION}" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   c) 版本号server变体: ${DOCKER_BASE}:${VERSION}-server"
          docker manifest inspect "${DOCKER_BASE}:${VERSION}-server" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   d) 版本号client变体: ${DOCKER_BASE}:${VERSION}-client"
          docker manifest inspect "${DOCKER_BASE}:${VERSION}-client" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   e) latest-server标签: ${DOCKER_BASE}:latest-server"
          docker manifest inspect "${DOCKER_BASE}:latest-server" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo "   f) latest-client标签: ${DOCKER_BASE}:latest-client"
          docker manifest inspect "${DOCKER_BASE}:latest-client" 2>/dev/null && echo "   ✓ 存在" || echo "   ✗ 不存在"
          
          echo ""
          
          # 测试拉取镜像
          echo "3. 测试拉取关键镜像:"
          echo "   拉取 GHCR 纯latest (无后缀)..."
          docker pull "${GHCR_BASE}:latest" --quiet 2>/dev/null && echo "   ✓ 成功" || echo "   ✗ 失败"
          
          echo "   拉取 GHCR 版本号标签 (无后缀)..."
          docker pull "${GHCR_BASE}:${VERSION}" --quiet 2>/dev/null && echo "   ✓ 成功" || echo "   ✗ 失败"
          
          echo "   拉取 GHCR latest-server..."
          docker pull "${GHCR_BASE}:latest-server" --quiet 2>/dev/null && echo "   ✓ 成功" || echo "   ✗ 失败"
          
          echo "   拉取 GHCR latest-client..."
          docker pull "${GHCR_BASE}:latest-client" --quiet 2>/dev/null && echo "   ✓ 成功" || echo "   ✗ 失败"
          
          echo ""
          
          # 显示镜像信息
          echo "4. 镜像信息:"
          echo "   架构支持: linux/amd64, linux/arm64"
          echo ""
          
          # 使用示例
          echo "5. 使用示例:"
          echo "   GHCR 纯latest标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest"
          echo ""
          echo "   GHCR latest-server标签:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:latest-server"
          echo ""
          echo "   GHCR latest-client标签:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:latest-client"
          echo ""
          echo "   GHCR 版本号标签 (server, 无后缀):"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}"
          echo ""
          echo "   GHCR 版本号server变体:"
          echo "   docker run -d --name anytls-server ${GHCR_BASE}:${VERSION}-server"
          echo ""
          echo "   GHCR 版本号client变体:"
          echo "   docker run -d --name anytls-client ${GHCR_BASE}:${VERSION}-client"
          
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo ""
            echo "   Docker Hub 纯latest标签 (server, 无后缀):"
            echo "   docker run -d --name anytls-server ${DOCKER_BASE}:latest"
          fi
          
          echo ""
          echo "=== 验证完成 ==="
          echo "所有镜像均已成功构建和推送"
          EOF
